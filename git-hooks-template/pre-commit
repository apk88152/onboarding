#!/usr/bin/env bash

# Block commits when staged files contain explicit AI usage indicators.
# Mirrors the onboarding guidance so reviewers remain blinded to AI tooling.
# Markdown (.md) files are explicitly scanned to prevent AI flag text in docs.

set -euo pipefail

declare -a PATTERNS=(
  "generated by cursor"
  "cursor ai"
  "cursor wrote this"
  "cursor suggestion"
  "generated by claude"
  "claude wrote this"
  "claude ai"
  "claude opus"
  "claude sonnet"
  "claude haiku"
  "claude code"
  "generated with claude code"
  "generated with \\[claude code\\]"
  "co-authored-by: claude"
  "noreply@anthropic\\.com"
  "generated by gemini"
  "gemini wrote this"
  "google gemini"
  "gemini ultra"
  "gemini pro"
  "gemini nano"
  "generated by bard"
  "bard wrote this"
  "google bard"
  "as an ai assistant"
  "as an ai"
  "ai assistant"
  "ai suggestion"
  "ai suggestions"
  "ai-generated"
  "ai generated"
  "ai-assisted"
  "ai assisted"
  "ai-powered"
  "ai powered"
  "powered by ai"
  "with ai assistance"
  "with the help of ai"
  "assisted by ai"
  "written with ai"
  "written by ai"
  "generated with ai"
  "generated via ai"
  "created with ai"
  "created by ai"
  "authored by ai"
  "co-authored by ai"
  "ai help"
  "ai helped"
  "ai copilot"
  "ai co-pilot"
  "chatgpt"
  "gpt-4"
  "gpt4"
  "gpt-3"
  "gpt3"
  "openai"
  "anthropic"
  "google ai"
  "google deepmind"
  "deepmind"
  "perplexity"
  "perplexity ai"
  "tabnine"
  "tabnine ai"
  "replit ghostwriter"
  "ghostwriter ai"
  "aws codewhisperer"
  "amazon codewhisperer"
  "code whisperer"
  "codewhisperer"
  "github copilot"
  "copilot"
  "amazon q"
  "amazon q developer"
  "meta ai"
  "deepseek"
  "phind"
  "blackbox ai"
  "magic ai"
  "ai model"
  "llm"
  "large language model"
  "language model"
  "\\[ai\\]"
  "\\[ai-generated\\]"
  "\\[cursor\\]"
  "\\[claude\\]"
  "\\[gemini\\]"
  "\\[copilot\\]"
  "\\[chatgpt\\]"
  "\\[llm\\]"
)

PATTERN_REGEX=$(printf '%s|' "${PATTERNS[@]}")
PATTERN_REGEX=${PATTERN_REGEX%|}

# Build a newline-separated list of binary file paths (bash 3.2 compatible)
BINARY_PATHS=""
while IFS=$'\t' read -r added deleted path; do
  [[ -z "${path:-}" ]] && continue
  if [[ "$added" == "-" || "$deleted" == "-" ]]; then
    BINARY_PATHS="${BINARY_PATHS}${path}"$'\n'
  fi
done < <(git diff --cached --numstat --diff-filter=ACMRT || true)

violations=0
report=""

while IFS= read -r -d '' file; do
  [[ -z "${file:-}" ]] && continue
  # Skip binary files by checking if path is in BINARY_PATHS
  if [[ -n "$BINARY_PATHS" ]] && echo "$BINARY_PATHS" | grep -qxF "$file"; then
    continue
  fi

  matches=$(git show ":$file" | LC_ALL=C grep -n -i -E "$PATTERN_REGEX" || true)
  if [[ -n "$matches" ]]; then
    ((violations++))
    report+=$'\n'"• $file"$'\n'"$matches"$'\n'
  fi
done < <(git diff --cached --name-only --diff-filter=ACMRT -z)

if (( violations > 0 )); then
  cat >&2 <<EOF
✖ Commit blocked: staged changes contain AI usage indicators.
Please remove or rephrase the highlighted lines before committing:$report
EOF
  exit 1
fi

exit 0
