#!/usr/bin/env bash

# Final safety check before pushing: scan all commits for AI indicators
# in both commit messages and file contents.
# Prevents accidental pushes of AI-flagged content that bypassed other hooks.

set -euo pipefail

declare -a PATTERNS=(
  "generated by cursor"
  "cursor ai"
  "cursor wrote this"
  "cursor suggestion"
  "generated by claude"
  "claude wrote this"
  "claude ai"
  "claude opus"
  "claude sonnet"
  "claude haiku"
  "claude code"
  "generated with claude code"
  "generated with \\[claude code\\]"
  "co-authored-by: claude"
  "noreply@anthropic\\.com"
  "generated by gemini"
  "gemini wrote this"
  "google gemini"
  "gemini ultra"
  "gemini pro"
  "gemini nano"
  "generated by bard"
  "bard wrote this"
  "google bard"
  "as an ai assistant"
  "as an ai"
  "ai assistant"
  "ai suggestion"
  "ai suggestions"
  "ai-generated"
  "ai generated"
  "ai-assisted"
  "ai assisted"
  "ai-powered"
  "ai powered"
  "powered by ai"
  "with ai assistance"
  "with the help of ai"
  "assisted by ai"
  "written with ai"
  "written by ai"
  "generated with ai"
  "generated via ai"
  "created with ai"
  "created by ai"
  "authored by ai"
  "co-authored by ai"
  "ai help"
  "ai helped"
  "ai copilot"
  "ai co-pilot"
  "chatgpt"
  "gpt-4"
  "gpt4"
  "gpt-3"
  "gpt3"
  "openai"
  "anthropic"
  "google ai"
  "google deepmind"
  "deepmind"
  "perplexity"
  "perplexity ai"
  "tabnine"
  "tabnine ai"
  "replit ghostwriter"
  "ghostwriter ai"
  "aws codewhisperer"
  "amazon codewhisperer"
  "code whisperer"
  "codewhisperer"
  "github copilot"
  "copilot"
  "amazon q"
  "amazon q developer"
  "meta ai"
  "deepseek"
  "phind"
  "blackbox ai"
  "magic ai"
  "ai model"
  "llm"
  "large language model"
  "language model"
  "\\[ai\\]"
  "\\[ai-generated\\]"
  "\\[cursor\\]"
  "\\[claude\\]"
  "\\[gemini\\]"
  "\\[copilot\\]"
  "\\[chatgpt\\]"
  "\\[llm\\]"
)

PATTERN_REGEX=$(printf '%s|' "${PATTERNS[@]}")
PATTERN_REGEX=${PATTERN_REGEX%|}

# Read stdin to get the remote name and URL
while read local_ref local_sha remote_ref remote_sha; do
  # Skip if deleting a branch
  if [[ "$local_sha" == "0000000000000000000000000000000000000000" ]]; then
    continue
  fi

  # If pushing a new branch, compare against empty tree
  if [[ "$remote_sha" == "0000000000000000000000000000000000000000" ]]; then
    range="$local_sha"
  else
    range="$remote_sha..$local_sha"
  fi

  # Check commit messages
  commit_violations=$(git log --format=%B "$range" | LC_ALL=C grep -n -i -E "$PATTERN_REGEX" || true)
  if [[ -n "$commit_violations" ]]; then
    cat >&2 <<EOF
✖ Push blocked: commit messages contain AI usage indicators.
Please amend your commits to remove AI references before pushing.

Violations found:
$commit_violations
EOF
    exit 1
  fi

  # Check file contents in the commits being pushed
  file_violations=""
  while IFS= read -r commit; do
    [[ -z "$commit" ]] && continue

    # Get list of files changed in this commit
    while IFS= read -r file; do
      [[ -z "$file" ]] && continue

      # Check if file still exists (not deleted)
      if git cat-file -e "$commit:$file" 2>/dev/null; then
        matches=$(git show "$commit:$file" | LC_ALL=C grep -n -i -E "$PATTERN_REGEX" || true)
        if [[ -n "$matches" ]]; then
          file_violations+=$'\n'"Commit: $commit"$'\n'"• $file"$'\n'"$matches"$'\n'
        fi
      fi
    done < <(git diff-tree --no-commit-id --name-only -r "$commit")
  done < <(git rev-list "$range")

  if [[ -n "$file_violations" ]]; then
    cat >&2 <<EOF
✖ Push blocked: file contents contain AI usage indicators.
Please remove or rephrase the highlighted content before pushing:$file_violations
EOF
    exit 1
  fi
done

exit 0
